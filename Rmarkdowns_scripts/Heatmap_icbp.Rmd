``dxx---
title: "heatmaps using icbp breast cancer cell line dataset"
output: html_document
---

```{r include=FALSE}
merge_drop<-function(x,y,by=0)
{
  new_m<-merge(x,y,by=by)
  rownames(new_m)<-new_m$Row.names
  return(new_m[,2:length(colnames(new_m))])
}


setwd("~/Dropbox/bild_signatures/multi_icbp_expr_pc/")
filenames<-system("ls */*/pathway_activity_testset*", intern=TRUE)
filenames

for(i in 1:length(filenames))
  {
   f<-read.csv(filenames[i], header=1,row.names=1) ###reading in the filess one at a time
  colnames(f)<-paste(filenames[i],colnames(f),sep='/')
  if(i==1){
    data<-f
    }
  else{
    data<-cbind(data,f)
    }
  }
#write.table(data,"~/Desktop/multipathway_preds.txt",sep='\t', col.names = NA,quote=F)
```

Shelley Making Her Subtype File
```{r}

drugs<-read.delim("~/Documents/ThesisWork/GitRepos/u01project/SignatureValidations/EGFR/ICBP/ICBP_drugs.txt", header=1, sep='\t',row.names=1)
data<-read.delim("~/Documents/ThesisWork/GitRepos/bild_signatures/multipathway_preds.txt", header=1, sep='\t',row.names=1) 
single=read.csv("~/Documents/ThesisWork/GitRepos/bild_signatures/single_pathway_results.csv") 

data_all<-cbind(data,single)
row.names(data_all)
rownames(data_all)[1:7]<-c("184A1","184B5","21MT1","21MT2","21NT","21PT","600MPE")
pred_drug<-merge_drop(data_all,drugs,by=0)
pred_drug=pred_drug[,-26]
dim(pred_drug)
View(pred_drug)
row.names(pred_drug)


basal<-subset(pred_drug,pred_drug$Transcriptional.subtype...ERBB2.status=="Basal")
View(basal) #10

her<-subset(pred_drug,pred_drug$Transcriptional.subtype...ERBB2.status=="ERBB2-amp"|pred_drug$Transcriptional.subtype...ERBB2.status=="ERBB2Amp")
dim(her) #21
View(her)
claudin<-subset(pred_drug,pred_drug$Transcriptional.subtype...ERBB2.status=="Claudin-low")
View(claudin) #5
luminal<-subset(pred_drug,pred_drug$Transcriptional.subtype...ERBB2.status=="Luminal")
View(luminal) #11

colnames(pred_drug)
head(pred_drug[4])
ncol(pred_drug)

ncol(pred_drug)
basal[40]
View(basal[41:129])

drug_prediction_correlations_multi= cor(pred_drug[1:25],pred_drug[36:125],use="na.or.complete")

basal[1:29]
basal[40:129]

basal_cor=cor(basal[1:29],basal[40:129],use="na.or.complete")
head(basal_cor)
her_cor=cor(her[1:29],her[40:129], use="na.or.complete")
head(her_cor)
claudin_cor=cor(claudin[1:29],claudin[40:129], use="na.or.complete")
head(claudin_cor)
lum_cor=cor(luminal[1:29],luminal[40:129], use="na.or.complete")
head(lum_cor)
View(claudin)

```







Now correlating multi pathway predictions with ICBP drugs..
```{r, cache=TRUE,include=FALSE,echo=FALSE}
drugs<-read.delim("~/Dropbox/bild_signatures/Datasets/ICBP_drugs.txt", header=1, sep='\t',row.names=1)
single<-read.csv("~/Dropbox/bild_signatures/multi_icbp_expr_pc/single_pathway_results.csv", row.names=1,header=1)

# mk2206<-read.table("~/Desktop/Drug reponse analysis/bildlab_drug response/mk2206.txt",sep='\t',row.names=1,header=1)
# mk2206
data_all<-cbind(data,single)
pred_drug<-merge_drop(data_all,drugs,by=0)
View(pred_drug)
#drug_srt<-subset(drugs,select = c("Lapatinib","Sigma.AKT1.2.inhibitor","Temsirolimus","Everolimus"))
#pred_drug<-merge_drop(data_all,drug_srt,by=0)
# mk2206<-subset(mk2206,select="Sensitivity..logEC50")
# pred_drug<-merge_drop(pred_drug,mk2206,by=0)
#dim(pred_drug)
#Correlating pathway activities with drug response in the ICBP breast cancer cell lines
#```{r}
# colnames(pred_drug)<-gsub(pattern = "pathway_activity_testset.csv",replacement = "",x = colnames(pred_drug))
# head(pred_drug)
# cors = matrix(0,8,4)
# rownames(cors)=colnames(pred_drug)[1:54]
# colnames(cors)=c("Lapatinib","Sigma.akt.1.2.inhibitor","Temsirolimus","Everolimus")
# pathways<-pred_drug[,1:54]
# drugs<-pred_drug[,55:58]
# 
# for (i in 1:length(colnames(data))){
#   for (j in 1:length(colnames(drug_srt))){
#     cors[i,j]=cor(pathways[,i],drugs[,j],use="pairwise.complete.obs")
#   }
# }
# 
# 
# write.table(cors,"~/Dropbox/bild_signatures/bild_signatures/Results/cor_mat_lapatinib_sigma_akt_ever_temsirolimus.txt",sep = '\t',col.names = NA,quote=F)

```


Creating heatmaps
```{r include=FALSE}

if (!require("gplots")) {
   install.packages("gplots", dependencies = TRUE)
   library(gplots)
   }
if (!require("RColorBrewer")) {
   install.packages("RColorBrewer", dependencies = TRUE)
   library(RColorBrewer)
   }
prediction_heatmap<-function(x,type=NULL)
{
  heatmap.2(as.matrix(x[,43:46]),col=my_palette,margins=c(12,9),dendrogram="none", trace="none",main=paste(type,"Multi Adap Pathway Activation Status",sep = " "),Rowv = NULL, Colv = NULL,cellnote = round(x[,43:46],digits = 2),notecol = 'black',density.info = "none",scale = 'row')

  heatmap.2(as.matrix(x[,51:54]),col=my_palette,margins=c(12,9),dendrogram="none",Rowv = NULL, Colv = NULL, trace="none",main=paste(type,"Single Adap Pathway Activation Status",sep = " "),cellnote = round(x[,51:54],digits = 2),notecol = 'black',density.info = 'none',scale = 'row')
}
correlation_heatmap<-function(x,drugs_names=NULL,type=NULL)
{
  cors = matrix(0,8,4)
  rownames(cors)=c(colnames(x)[43:46],colnames(x)[51:54])#selecting the adaptive multipathway and single pathway prediction columns
  pathways<-cbind(x[,43:46],x[,51:54])
  drugs<-subset(x,select=drugs_names)
  colnames(drugs)=colnames(cors)=drugs_names
  for (i in 1:length(colnames(pathways))){
    for (j in 1:length(colnames(drugs))){
      cors[i,j]=cor(pathways[,i],drugs[,j],use="pairwise.complete.obs")
    }
  }

heatmap.2(as.matrix(cors),col=redgreen,margins=c(12,9),dendrogram="none",Rowv = NULL, Colv = NULL, trace="none",main=paste("Correlations of predicted ","pathway activation with drug response in",type,sep='\n '),cellnote = round(cors,digits = 2),notecol = 'black',density.info = 'none')
}

multi<-data#read.table("~/Desktop/multipathway_preds.txt", sep='\t',row.names=1,header=1)
single<-read.csv("~/Dropbox/bild_signatures/multi_icbp_expr_pc/single_pathway_results.csv", row.names=1,header=1)
my_palette <- colorRampPalette(c("darkblue","aliceblue","brown4"))(n = 299)
col_breaks = c(seq(0,0.2,length=100), seq(0.2,0.4,length=100), seq(0.4,1,length=100)) 
# # creates a 5 x 5 inch image
# png("heatmaps_in_r.png",    # create PNG for the heat map        
#   width = 5*300,        # 5 x 300 pixels
#   height = 5*300,
#   res = 300,            # 300 pixels per inch
#   pointsize = 8)  
comb<-cbind(multi,single)
dim(comb)
comb_drug<-merge_drop(pred_drug[,1:54],drugs,by=0)
colnames(comb_drug)<-gsub(pattern = "adap_multi.pathway_activity_testset.csv",replacement = "A",x = colnames(comb_drug))
#colnames(comb)<-gsub(pattern = "non",replacement = "NA",x = colnames(comb))
rownames(comb)[1:7]<-c("184A1","184B5","21MT1","21MT2","21NT","21PT","600MPE")

pdf(file='~/Dropbox/bild_signatures//bild_signatures/activity_subtype.pdf')


heatmap.2(as.matrix(comb[,43:46]),col=my_palette,trace="none",main="Predicted Multipathway Adaptive Activity",margins=c(12,9),Rowv =F,Colv=F,dendrogram="none",ylab="ICBP Cell lines",breaks = col_breaks)
heatmap.2(as.matrix(comb[,51:54]),margins=c(12,9),col=my_palette, Rowv=F,Colv=F,dendrogram="none",trace="none",main="Predicted Single Pathway Activity",ylab="ICBP Cell lines",scale = "row")

colnames(pred_drug)<-gsub(pattern = "pathway_activity_testset.csv",replacement = "",x = colnames(pred_drug))
drugs_names=c("Lapatinib","Sigma.AKT1.2.inhibitor","Temsirolimus","Everolimus")

```
Creating  heatmaps for predictions and drug response correlatins with pathway activity within subtypes

```{r}
basal<-subset(comb_drug,comb_drug$Transcriptional.subtype...ERBB2.status=="Basal")
prediction_heatmap(x=basal,type = "BASAL")
correlation_heatmap(x=basal,drugs_names =drugs_names,type = "BASAL" )

her<-subset(comb_drug,comb_drug$Transcriptional.subtype...ERBB2.status=="ERBB2-amp"|comb_drug$Transcriptional.subtype...ERBB2.status=="ERBB2Amp")
prediction_heatmap(x=her,type = "ERBB2 Amplified")
correlation_heatmap(x=her,drugs_names =drugs_names,type = "ERBB2 amplified" )

claudin<-subset(comb_drug,comb_drug$Transcriptional.subtype...ERBB2.status=="Claudin-low")
prediction_heatmap(x=claudin,type = "Claudin Low")
correlation_heatmap(x=claudin,drugs_names =drugs_names,type = "Claudin Low" )###no variance in lapatinib drug response correlation cannot be determined

luminal<-subset(comb_drug,comb_drug$Transcriptional.subtype...ERBB2.status=="Luminal")
prediction_heatmap(x=luminal,type = "Luminal")
correlation_heatmap(x=luminal,drugs_names =drugs_names,type = "Luminal" )###no variance in lapatinib drug response correlation cannot be determined
```
Now, trying to see patterns across all the subtypes in ICBP breast cancer cell lines
```{r}
multi_4<- rbind(basal[,43:46],her[,43:46],claudin[,43:46],luminal[,43:46])
#png("heatmaps_multi_adap.png",width = 5*300,height = 5*300,res = 800, pointsize = 8)  
heatmap.2(as.matrix(multi_4), RowSideColors = c(rep("gray", length(rownames(basal))),rep("blue", length(rownames(her))),rep("black", length(rownames(claudin))),rep("green",length(rownames(luminal)))),col=my_palette,dendrogram="none", trace="none",margins=c(12,9),main="Multi Preds within Subtypes",scale='row',Rowv=F)
par(lend = 1)           # square line ends for the color legend
legend("topright",legend = c("Basal", "HER2", "Claudin","Luminal"), col = c("gray", "blue", "black","green"),  lty= 1,lwd = 10)

single_4<-rbind(basal[,51:54],her[,51:54],claudin[,51:54],luminal[,51:54])
heatmap.2(as.matrix(single_4), RowSideColors = c(rep("gray", length(rownames(basal))),rep("blue", length(rownames(her))),rep("black", length(rownames(claudin))),rep("green",length(rownames(luminal)))),col=my_palette,dendrogram="none", trace="none",margins=c(12,9),main="Single Preds within Subtypes",scale="row",Rowv=F)
par(lend = 1)           # square line ends for the color legend
legend("topright",legend = c("Basal", "HER2", "Claudin","Luminal"), col = c("gray", "blue", "black","green"),  lty =  1,lwd = 10)


```

```{r echo=FALSE}
time<-format(Sys.time(),"%a %b %d %X %Y")
```
This analysis was run on `r time` 

